<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>IKOMA Runner - {{ app_id }}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f7f7f7; text-align: left; }
        .section { margin-bottom: 2rem; }
        .logs { list-style: none; padding-left: 0; }
        .logs li { margin: 4px 0; }
        .status { padding: 0.5rem; background: #eef; border: 1px solid #ccd; }
        form { display: block; margin-top: 1rem; }
        label { display: block; margin-top: 0.5rem; }
        input, select { padding: 4px; width: 100%; }
        .actions { display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <h1>Application: {{ app_id }}</h1>
    <p><a href="/">&larr; Retour</a></p>

    {% if status_message or status_detail %}
    <div class="status">
        <strong>{{ status_message }}</strong>
        {% if status_detail %}<div>{{ status_detail }}</div>{% endif %}
    </div>
    {% endif %}

    <div class="section">
        <h2>Configuration</h2>
        <form method="post" action="/apps/{{ app_id }}/update">
            <label>repo_git_url</label>
            <input type="text" name="repo_git_url" value="{{ config.repo_git_url }}" required />

            <label>branche (default: main)</label>
            <input type="text" name="branch" value="{{ config.branch }}" />

            <label>path_deploiement</label>
            <input type="text" name="path_deploiement" value="{{ config.path_deploiement }}" />

            <label>migrations_dir (optionnel)</label>
            <input type="text" name="migrations_dir" value="{{ config.migrations_dir }}" placeholder="supabase/migrations" />

            <label>type_app</label>
            <select name="type_app">
                <option value="lovable" {% if config.type_app == 'lovable' %}selected{% endif %}>lovable</option>
                <option value="generic" {% if config.type_app == 'generic' %}selected{% endif %}>generic</option>
            </select>

            <div class="actions">
                <button type="submit">Mettre à jour</button>
            </div>
        </form>

        <form method="post" action="/apps/{{ app_id }}/sync">
            <div class="actions">
                <button type="submit">Clone / Update</button>
            </div>
        </form>
    </div>

    <div class="section">
        <h2>Dernier déploiement</h2>
        {% if deployment %}
        <table>
            <tr><th>Ref</th><td>{{ deployment.ref }}</td></tr>
            <tr><th>Status</th><td>{{ deployment.status }}</td></tr>
            <tr><th>Message</th><td>{{ deployment.message }}</td></tr>
            <tr><th>Mis à jour</th><td>{{ deployment.updated_at }}</td></tr>
        </table>
        {% else %}
            <p>Aucun déploiement connu.</p>
        {% endif %}
    </div>

    <div class="section">
        <h2>Dernière migration Supabase</h2>
        {% if supabase_run %}
        <table>
            <tr><th>Status</th><td>{{ supabase_run.status }}</td></tr>
            <tr><th>Message</th><td>{{ supabase_run.message }}</td></tr>
            <tr><th>Mis à jour</th><td>{{ supabase_run.updated_at }}</td></tr>
            <tr><th>Migrations</th><td>{{ supabase_run.migrations }}</td></tr>
        </table>
        {% else %}
            <p>Aucune migration enregistrée.</p>
        {% endif %}
    </div>

    <div class="section">
        <h2>Actions</h2>
        <form method="post" action="/apps/{{ app_id }}/deploy">
            <label>Ref Git (default {{ config.branch }})</label>
            <input type="text" name="ref" value="{{ config.branch }}" />
            <button type="submit">Deploy</button>
        </form>

        <form method="post" action="/apps/{{ app_id }}/migrate">
            <label>Repo path (default {{ config.path_deploiement }})</label>
            <input type="text" name="repo_path" value="{{ config.path_deploiement }}" />
            <label>migrations_dir (default {{ config.migrations_dir or 'supabase/migrations' }})</label>
            <input type="text" name="migrations_dir" value="{{ config.migrations_dir or 'supabase/migrations' }}" />
            <button type="submit">Migrate</button>
        </form>
    </div>

    <div class="section">
        <h2>Logs</h2>
        {% if logs %}
        <ul class="logs">
            {% for log in logs %}
            <li><a href="/apps/{{ app_id }}/logs/{{ log.name }}">{{ log.name }}</a></li>
            {% endfor %}
        </ul>
        {% else %}
            <p>Aucun log trouvé.</p>
        {% endif %}
    </div>
</body>
</html>

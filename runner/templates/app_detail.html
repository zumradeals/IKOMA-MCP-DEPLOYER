<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>IKOMA Runner - {{ app_id }}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f7f7f7; text-align: left; }
        .section { margin-bottom: 2rem; }
        .logs { list-style: none; padding-left: 0; }
        .logs li { margin: 4px 0; }
        .status { padding: 0.5rem; background: #eef; border: 1px solid #ccd; }
        form { display: inline-block; margin-right: 1rem; }
        label { display: block; margin-top: 0.5rem; }
        input { padding: 4px; }
    </style>
</head>
<body>
    <h1>Application: {{ app_id }}</h1>
    <p><a href="/">&larr; Retour</a></p>

    {% if status_message or status_detail %}
    <div class="status">
        <strong>{{ status_message }}</strong>
        {% if status_detail %}<div>{{ status_detail }}</div>{% endif %}
    </div>
    {% endif %}

    <div class="section">
        <h2>Dernier déploiement</h2>
        {% if deployment %}
        <table>
            <tr><th>Ref</th><td>{{ deployment.ref }}</td></tr>
            <tr><th>Status</th><td>{{ deployment.status }}</td></tr>
            <tr><th>Message</th><td>{{ deployment.message }}</td></tr>
            <tr><th>Mis à jour</th><td>{{ deployment.updated_at }}</td></tr>
        </table>
        {% else %}
            <p>Aucun déploiement connu.</p>
        {% endif %}
    </div>

    <div class="section">
        <h2>Dernière migration Supabase</h2>
        {% if supabase_run %}
        <table>
            <tr><th>Status</th><td>{{ supabase_run.status }}</td></tr>
            <tr><th>Message</th><td>{{ supabase_run.message }}</td></tr>
            <tr><th>Mis à jour</th><td>{{ supabase_run.updated_at }}</td></tr>
            <tr><th>Migrations</th><td>{{ supabase_run.migrations }}</td></tr>
        </table>
        {% else %}
            <p>Aucune migration enregistrée.</p>
        {% endif %}
    </div>

    <div class="section">
        <h2>Actions</h2>
        <form method="post" action="/apps/{{ app_id }}/deploy">
            <label>Ref Git (default main)</label>
            <input type="text" name="ref" value="main" />
            <button type="submit">Deploy</button>
        </form>

        <form method="post" action="/apps/{{ app_id }}/migrate">
            <label>Repo path (ex: /opt/ikomaposte)</label>
            <input type="text" name="repo_path" required />
            <label>migrations_dir (default supabase/migrations)</label>
            <input type="text" name="migrations_dir" value="supabase/migrations" />
            <button type="submit">Migrate</button>
        </form>
    </div>

    <div class="section">
        <h2>Logs</h2>
        {% if logs %}
        <ul class="logs">
            {% for log in logs %}
            <li><a href="/apps/{{ app_id }}/logs/{{ log.name }}">{{ log.name }}</a></li>
            {% endfor %}
        </ul>
        {% else %}
            <p>Aucun log trouvé.</p>
        {% endif %}
    </div>
</body>
</html>

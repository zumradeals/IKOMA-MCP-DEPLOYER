#!/usr/bin/env python3
"""CLI IKOMA BRIDGE (stub).

Offre l'aide et la structure des commandes futures sans implémentation métier.
"""
from __future__ import annotations

import argparse
from pathlib import Path
from typing import List

from core.services.supabase import supabase_apply_migrations


def build_parser() -> argparse.ArgumentParser:
    parser = argparse.ArgumentParser(description="IKOMA BRIDGE CLI (stub)")

    subparsers = parser.add_subparsers(dest="command", required=True)

    deploy_parser = subparsers.add_parser("deploy", help="Gestion des déploiements")
    deploy_sub = deploy_parser.add_subparsers(dest="deploy_cmd", required=False)
    deploy_sub.add_parser("up", help="Déclencher un déploiement vers un environnement")
    deploy_sub.add_parser("rollback", help="Revenir à une version précédente")

    pipeline_parser = subparsers.add_parser("pipeline", help="Pilotage des pipelines")
    pipeline_sub = pipeline_parser.add_subparsers(dest="pipeline_cmd", required=False)
    pipeline_sub.add_parser("run", help="Lancer un pipeline Lovable → GitHub → VPS")

    supabase_parser = subparsers.add_parser("supabase", help="Opérations Supabase")
    supabase_sub = supabase_parser.add_subparsers(dest="supabase_cmd", required=False)
    supabase_sub.add_parser("ensure", help="Vérifier/initialiser les ressources Supabase nécessaires")
    migrate_cmd = supabase_sub.add_parser("migrate", help="Appliquer les migrations Supabase")
    migrate_cmd.add_argument("--app", required=True, dest="app_id", help="Identifiant applicatif")
    migrate_cmd.add_argument("--repo", required=True, dest="repo_path", help="Chemin du dépôt à migrer")

    backup_parser = subparsers.add_parser("backup", help="Gestion des sauvegardes")
    backup_sub = backup_parser.add_subparsers(dest="backup_cmd", required=False)
    backup_sub.add_parser("run", help="Lancer un backup applicatif/infra")

    restore_parser = subparsers.add_parser("restore", help="Gestion des restaurations")
    restore_sub = restore_parser.add_subparsers(dest="restore_cmd", required=False)
    restore_sub.add_parser("run", help="Restaurer un backup spécifié")

    return parser


def main(args: List[str] | None = None) -> int:
    parser = build_parser()
    parsed = parser.parse_args(args=args)

    if parsed.command == "supabase" and parsed.supabase_cmd == "migrate":
        supabase_apply_migrations(parsed.app_id, Path(parsed.repo_path))
        return 0

    # Ici, aucune logique métier : uniquement l'affichage de l'aide/structure.
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
